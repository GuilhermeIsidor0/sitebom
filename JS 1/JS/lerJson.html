<!DOCTYPE html>
<html>
<head>
    <title>Leitura de JSON em JavaScript</title>
    <style>
        body, input {
            text-align: center;
        }

        input {
            border-color: blue;
            border-radius: 5px;
            height: 25px;
            font-size: 20px;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }

        form {
            flex-direction: column;
            display: flex;
            width: 300px;
            margin: 0 auto;
        }

        form, label, input {
            margin-bottom: 15px;
        }

        .error {
            color: red;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        button {
            color: black;
            font-size: 20px;
            cursor: pointer;
        }

        button:hover {
            color: red;
            font-size: 22px;
        }

        .historico {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <fieldset>
        <form id="formPesquisa">
            <input type="text" id="cep" placeholder="Digite o CEP" maxlength="8">
  
            <input type="text" id="estado" placeholder="Estado" readonly>
            <input type="text" id="cidade" placeholder="Cidade" readonly>
            <input type="text" id="bairro" placeholder="Bairro" readonly>
            <input type="text" id="rua" placeholder="Rua" readonly>

            <span id="message"></span>

            <button type="submit">Pesquisar</button>
            <button type="button" id="limpar">Limpar</button>
        </form>
    </fieldset>

    <div id="resultados"></div>
    <div id="historico" class="historico"></div>

    <script>
        async function buscarEnderecoPorCep(cep) {
            try {
                const response = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Erro ao buscar endereço por CEP:', error);
                throw new Error('Erro ao buscar o CEP');
            }
        }

        function atualizarHistorico(cep) {
            let historico = JSON.parse(localStorage.getItem('historico')) || [];
            if (!historico.includes(cep)) {
                historico.push(cep);
                localStorage.setItem('historico', JSON.stringify(historico));
            }
            exibirHistorico();
        }

        function exibirHistorico() {
            const historicoDiv = document.getElementById('historico');
            const historico = JSON.parse(localStorage.getItem('historico')) || [];
            historicoDiv.innerHTML = '<h3>Histórico de Pesquisas:</h3>';
            historico.forEach(cep => {
                const p = document.createElement('p');
                p.textContent = cep;
                p.style.cursor = 'pointer';
                p.addEventListener('click', () => {
                    document.getElementById('cep').value = cep;
                    document.getElementById('cep').dispatchEvent(new Event('focusout'));
                });
                historicoDiv.appendChild(p);
            });
        }

        function exibirResultados(resultados) {
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = `CEP: ${resultados.cep}, Logradouro: ${resultados.street}, Bairro: ${resultados.neighborhood}, Cidade: ${resultados.city}, Estado: ${resultados.state}`;
            resultadosDiv.appendChild(p);
            atualizarHistorico(resultados.cep);
        }

        document.getElementById('cep').addEventListener('focusout', async function() {
            const cep = document.getElementById('cep').value;
            const message = document.getElementById('message');

            try {
                if (!/^[0-9]{8}$/.test(cep)) throw {errorcep: 'CEP inválido'};
                
                const data = await buscarEnderecoPorCep(cep);
                if (!data.cep) throw {errorcep: 'CEP não encontrado'};

                document.getElementById('estado').value = data.state;
                document.getElementById('cidade').value = data.city;
                document.getElementById('bairro').value = data.neighborhood;
                document.getElementById('rua').value = data.street;

                exibirResultados(data);
            } catch (error) {
                if (error?.errorcep) {
                    message.textContent = error.errorcep;
                    setTimeout(() => { message.textContent = ''; }, 5000);
                }
            }
        });

        document.getElementById('formPesquisa').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const cep = document.getElementById('cep').value;

            try {
                if (cep) {
                    const data = await buscarEnderecoPorCep(cep);
                    if (!data.cep) throw new Error('CEP não encontrado');
                    exibirResultados(data);
                } else {
                    throw new Error('Digite um CEP');
                }
            } catch (error) {
                const resultadosDiv = document.getElementById('resultados');
                resultadosDiv.innerHTML = `<p class="error">${error.message}</p>`;
            }
        });

        document.getElementById('limpar').addEventListener('click', function() {
            document.getElementById('cep').value = '';
            document.getElementById('estado').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('rua').value = '';
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('message').textContent = '';
        });

        window.onload = function() {
            exibirHistorico();
        };
    </script>

</body>
</html>
